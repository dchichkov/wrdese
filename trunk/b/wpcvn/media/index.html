<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
  <html>
  <head> <title>WP CVN</title> </head>

<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/themes/smoothness/jquery-ui.css"/>
<link rel="stylesheet" type="text/css" href="m/datatables/media/css/demo_table_jui.css" />
<link rel="stylesheet" type="text/css" href="m/css/layout-default-latest.css" />


<style type="text/css" title="currentStyle">
	body {font-size: 80%;}	
	table {font-size: 1em;}	

    table td {white-space: nowrap;}
    .toolbar {float:left; margin-top:3px; margin-right:3px;}
    .refresh {float:left; margin-right:3px;}
  
    #status {padding: 2px;}
    .sm-button {font-size:80%; margin-left:1px;}

	/* Layout Theme */
	.ui-layout-pane { 
		padding:	0px; 
		overflow:	hidden;
	} 
	.ui-layout-pane-north { 
		padding:	0px; 
		overflow:	hidden;
	}
	
	.ui-layout-south {
		display:	none;
		overflow:	hidden;
	}
	iframe {
		padding:	0 !important; /* iframes should not have padding */
		overflow:	auto !important;		
	}

	
</style>

<script type="text/javascript" language="javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" language="javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.1/jquery-ui.min.js"></script>
<script type="text/javascript" language="javascript" src="m/datatables/media/js/jquery.dataTables.js"></script>
<script type="text/javascript" language="javascript" src="m/js/jquery.timeFormat.js"></script>
<script type="text/javascript" language="javascript" src="m/js/jquery.cookie.js"></script>
<script type="text/javascript" language="javascript" src="m/js/jquery.Guid.js"></script>
<script type="text/javascript" language="javascript" src="m/js/jquery.layout-latest.js"></script>


<script type="text/javascript" charset="utf-8">
	var t, users, nick = '', wid = '', guid = String(jQuery.Guid.New());
	
	guid = "4AB96246-AC5F-65E0-EE6B-701A45A83141";
	
	function ellipsis(text, n) {
    if(text.length>n)
        return text.substring(0,n)+"...";
    else
        return text;	
	}


    function login()
    {
		// $.get("s/ip", function(data){ip = data.ip})
		

		
        //tid = $.cookie('tid_cookie')
        //if(tid)
        // {
        //     $.get("s/tid", function(data){
        //         alert( "Your ip: " + data.ip);
        //     });
        // }

        // $.cookie('tid_cookie', 'the_value'); // set cookie
        // $.cookie('tid_cookie', 'the_value', { expires: 7 }); // set cookie with an expiration date seven days in the future
        // $.cookie('the_cookie', '', { expires: -1 }); // delete cookie

        
        // $.get("s/ip", function(data){
        //    alert("Your ip: " + data.ip);
		//		});

    }

	function successful_autoconfirm()
	{
        var $dialog = $('<div></div>')
            .html("wid = " + wid + "<br>" + "nick = " + nick) 
            .dialog({ 	title: 'Autoconfirmation Successful',
						modal: true, 
					  	buttons: { "Ok": function() { $(this).dialog("close"); } },
					  	width: 400									
						});		
	}

	function try_autoconfirm()
	{	
        var $dialog = $('<div></div>')
            .html("<p>Verificaion is a single-step process, basically you need to do a nonempty edit to the Wikipedia:Sandbox and leave the following ugly string as a comment: "
				  + guid + "</p>"

                  + "<p>It's a hassle. But you only have to do it once. And it is a good idea to do it, "
                  + "because other members will be able to see your contributions having Verified Status. "

				  + "<p>Here is a "
				  + '<a class="ui-priority-primary ui-state-highlight" href="http://en.wikipedia.org/w/index.php?title=Wikipedia:Sandbox&action=edit&minor=true&section=0&summary=' + guid +'" target="_blank">link</a>' 
				  + " that would take you to the Wikipedia:Sandbox and prefill the comment. </p>"
				  + "<p>Make sure you are <b>using your Wikipedia account</b>. You also need to actually modify the sandbox content, <b>empty edit won't register</b>. "
				  + "A good idea would be to patrol, to add some fancy markup, or just to add a token, like 'wpcvn'.</p>"
				  + '<p><div class="refresh ui-state-default ui-corner-all">'
                  +  '<span class="ui-icon ui-icon-refresh">close</span></div>'
                  +  '<span class="ui-button-text">Waiting for your edit...</span></p>' 
				   )
				  		
            .dialog({ 	title: 'Autoconfirmation',
						modal: true, 
					  	buttons: { "Cancel": function() { $(this).dialog("close"); } },
					  	width: 600,									
						open: function() { this.updater = window.setInterval(update_wid, 500);},						 
 						close: function() { window.clearInterval(this.updater)}									
						});
						
		function update_wid()
		{
			$.post("s/wid", {'guid': guid}, 
					function(data) 
					{
						wid = data.wid;
						nick = data.nick;
						if(nick || wid)
						{ 
							$dialog.dialog('close');
							successful_autoconfirm();							
						}
					}
					);									
		}
	}	


  $(document).ready(function() {  		
	// Generic Setup
	$.ajaxSetup('timeout', 1000)
    
	// Try authentication  		
    login();
	
	// Enable jQuery Layout 
	myLayout = $("body").layout({
		initClosed:		false
	,	north__size:	40
	,	south__size:	222
	,	west__size:		200
	,	autoStateManagement:	true	// enable state management	
	,	useStateCookie:		true		// enable state autoSave
	});
	

	// Main Window datatable 	
  	t = $('#table').dataTable({
		
		"fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                            var $cell=$('td:eq(0)', nRow);
                            $cell.text( $.timeFormat($cell.text()) );

							
                            var $cell=$('td:eq(1)', nRow);
							if($cell.text() < -5) $cell.css({fontWeight:"bold", color:"#FF0000"}); 
							else if($cell.text() < 0) $cell.css("color", "#FF0000");
							else if($cell.text() > 100) $cell.css("color", "#348017");
						
							
                            var $cell=$('td:eq(4)', nRow);
                            $cell.text(ellipsis($cell.text(),25));

							
                            var $cell=$('td:eq(5)', nRow);
							page = $cell.text()
                            $cell.text(ellipsis($cell.text(),25));
							
                            var $cell=$('td:eq(6)', nRow);
							page = $cell.text()
                            $cell.text(ellipsis($cell.text(),50));
							
                            var $cell=$('td:eq(3)', nRow);
                            $cell.html('<a href="' + $cell.text() + ' " target="_blank">diff...</a>');
							$cell.attr("alt", page)
							$cell.click(function() {$.post("s/c", $(this).attr("alt"));});
                            return nRow;
                    },
        "aoColumns": [{ "bSortable": true }, { "bSortable": true }, { "bSortable": true }, { "bSortable": false },
                        { "bSortable": false }, { "bSortable": false }, { "bSortable": false }, { "bSortable": false }],
        "bJQueryUI": true,
        "sPaginationType": "full_numbers",
        "bProcessing": false,
        "bServerSide": true,
		"bAutoWidth": false,
        "sAjaxSource": "s/w",
		"sDom": '<"H" <"toolbar"> lfr >t<"F"ip>',
        "oLanguage" : {"sSearch": "Filter Users:"},
        "fnServerData": function (sSource, aoData, fnCallback) {
			aoData.push( { "name": "nick", "value": $("#nick").val() } );
			aoData.push( { "name": "wid", "value": wid } );
			$.ajax ( {"dataType": 'json', "type": "POST", "url": sSource, "data": aoData, "success": fnCallback} );		
         }
     } );
	 
	 // Main Window datatable Toolbar/Refresh
	 $("div.toolbar").html('<div class="refresh ui-state-default ui-corner-all"><span class="ui-icon ui-icon-refresh">close</span></div>')

	 $(document).ajaxSend(function(r,s) {$(".refresh").addClass('ui-state-highlight')});
	 $(document).ajaxStop(function(r,s) {$(".refresh").removeClass('ui-state-highlight')});
	 $(document).ajaxError(function(r,s) {$(".refresh").addClass('ui-state-error')});
	 $(document).ajaxSuccess(function(r,s) {$(".refresh").removeClass('ui-state-error')});


	// Users datatable
  	users = $('#users').dataTable({
		
		"fnRowCallback": function( nRow, aData, iDisplayIndex ) {
                            var $cell=$('td:eq(1)', nRow);
                            $cell.text( $.timeFormat($cell.text()) );
                            return nRow;
                    },
		"aoColumns": [{ "bSortable": false }, { "bSortable": false }],
        "bJQueryUI": true,
        "bProcessing": false,
        "bFilter": false,
		"bLengthChange": false,
		// "bSort": false,
		"bInfo": false,
        "bServerSide": true,
		"bAutoWidth": false,
        "sAjaxSource": "s/users",
        "fnServerData": function (sSource, aoData, fnCallback) {
			aoData.push( { "name": "nick", "value": $("#nick").val() } );
			aoData.push( { "name": "wid", "value": wid } );
            $.ajax ( {"dataType": 'json', "type": "GET", "url": sSource, "data": aoData, "success": fnCallback} );
         }
     } );

	// Start Refreshing
	window.setInterval(function() {t.fnDraw(); users.fnDraw();}, 10000);

    // Mics
    $("#autoconfirm").click(try_autoconfirm)
  } );
</script>


<body>  
	<div class="ui-layout-north">
        <div id="status" class="ui-widget-header ui-corner-all">
            Nick:         
            <input id="nick" type="text" class="ui-widget"/>
            <button id="autoconfirm" class="sm-button ui-button ui-button-text-icon ui-widget ui-state-default ui-corner-all">
                <span class="ui-button-icon-primary ui-icon ui-icon-locked"></span>
                <span class="ui-button-text">Autoconfirm...</span>
            </button>
        </div>
	</div>



	<div class="ui-layout-center">
		<table cellspacing="0" border="0" class="display ui-helper-reset" id="table">
		        <thead>
		                <tr>
		                        <th width="10%">Time</th>
		                        <th width="5%">Trust</th>
		                        <th width="5%">Views</th>
		                        <th width="5%">Url</th>
		                        <th width="10%">User</th>
		                        <th width="20%">Page</th>
		                        <th width="45%">Summary</th>
		                </tr>
		        </thead>
		        <tbody>
		        </tbody>
		</table>
	</div>
	
	
	<div class="ui-layout-west">
		<table cellspacing="0" border="0" class="display" id="users">
		        <thead>
		                <tr>
		                        <th width="60%">Nick</th>
		                        <th width="40%">Last Seen</th>
		                </tr>
		        </thead>
		        <tbody>
		        </tbody>
		</table>
	</div>
	
	<div class="ui-layout-south">	
		<!-- iframe src="http://webchat.freenode.net?channels=countervandalism" width="100%" height="100%" frameborder="0"></iframe -->
	</div>

</body>
</html>
